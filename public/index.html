<!DOCTYPE html>
<html ng-app="appName">
<head>
    <!-- META -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>subnetter</title>

    <link rel="stylesheet" href="bower_components/bootstrap-css-only/css/bootstrap.min.css">

    <style>
      html                    {
                                overflow-y:scroll;
                                height: 100vh;
                              }
      body                    {
                                padding-top:1vh;
                                height: 100vh;
                              }
      .form-group             { margin-bottom: 5px; }
      .ace_editor             {
                              border: 1px solid lightgray;
                              height: 95vh;
                              width: 100%;
                            }
    .jsoneditor .menu       {
                              background-color: #D5DDF6;
                              border-bottom: 1px solid #97B0F8;
                            }
    .row                    {
                              margin-left: 0px;
                              margin-right: 0px;
                            }
    </style>


    <script type="text/javascript" src="bower_components/ace-builds/src-min-noconflict/ace.js"></script>
    <script type="text/javascript" src="bower_components/angular/angular.js"></script>
    <script type="text/javascript" src="bower_components/angular-ui-ace/ui-ace.js"></script>
    <script type="text/javascript" src="//angular-ui.github.io/bootstrap/ui-bootstrap-tpls-1.2.1.js"></script>
    <script src="js-yaml.min.js"></script>
    <script src="app.js"></script>



</head>
<body ng-controller="mainController">
    <div class="container-fluid">
      <uib-alert class="col-sm-6 col-sm-offset-3" ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">
        <span ng-bind-html="alert.msg"></span>
      </uib-alert>
      <div class="row">
        <div class="col-sm-6">
          <div class="row">
            <big><strong>Template</strong></big>
            <button type="submit" class="btn btn-primary btn-xs pull-right" ng-click="do(value)">
               <span class="glyphicon glyphicon glyphicon-repeat" aria-hidden="true"></span> convert
            </button>
          </div>
          <div class="row">
            <div ui-ace="aceyamlOptions" ng-model="acedata"></div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="row">
              <big><strong>json</strong></big>
              <button type="submit" class="btn btn-primary btn-xs pull-right" ng-click="opend3js()">
                 <span class="glyphicon glyphicon glyphicon-new-window" aria-hidden="true"></span> render
              </button>
          </div>
          <div class="row">
            <div ui-ace="acejsonOptions" ng-model="acejson"></div>
          </div>
        </div>
      </div>
    </div>
</body>

<script>

window.onerror = function(msg, url, line, col, error) {
   // Note that col & error are new to the HTML 5 spec and may not be
   // supported in every browser.  It worked for me in Chrome.
   var extra = !col ? '' : '\ncolumn: ' + col;
   extra += !error ? '' : '\nerror: ' + error;

   // You can view the information in an alert to see things working like this:
   alert("Error: " + msg + "\nurl: " + url + "\nline: " + line + extra);

   // TODO: Report this error via ajax so you can keep track
   //       of what pages have JS issues

   var suppressErrorAlert = true;
   // If you return true, then error alerts (like in older versions of
   // Internet Explorer) will be suppressed.
   return suppressErrorAlert;
};

function uniques(arr) {
    if (arr == null) {
      return new Array;
    } else {
      var a = [];
      for (var i=0, l=arr.length; i<l; i++)
          if (a.indexOf(arr[i]) === -1 && arr[i] !== '')
              a.push(arr[i]);
      return a;
    }
}


angular
    .module("appName", ['ui.bootstrap', 'ui.ace'])
    .controller("mainController", mainController);

mainController.$inject = ["$scope", "$http", "$sce", "$log", "$window"];

function mainController($scope, $http, $sce, $log, $window) {
  $scope.design = "";
  $scope.acedata ='';
  $scope.acejson ='';
  $scope.acejsonOptions = {
    onLoad: function (_ace) {
      _ace.getSession().setMode("ace/mode/json");
      _ace.$blockScrolling = Infinity;
    }
  };
  $scope.aceyamlOptions = {
    onLoad: function (_ace) {
      _ace.getSession().setMode("ace/mode/yaml");
      _ace.$blockScrolling = Infinity;
    }
  };

  $scope.opend3js = function(greeting) {
    var w = $window.open("d3js.html");
  };

  $scope.do = function() {
    try {
      var design = jsyaml.load($scope.acedata);
      var designtext = $scope.acedata;
      var matches = uniques($scope.acedata.match(/{{\s*[\w\.]+\s*}}/g))
      if (matches.length > 0) {
        for (var i = 0; i < matches.length; i++) {
          var replace = matches[i].match(/[\w\.]+/)[0];
          var replacewith = design[replace]
          designtext = designtext.replace(new RegExp(matches[i], 'g'), replacewith);
        }
      }
      design = jsyaml.load(designtext);
      var start = design.root
      var parts = network2nm(start)
      var mask = Number(parts.mask)
      var ips = Math.pow(2,32-mask)
      var answer = subnets(design.root, design.spec)
      var json = {
        network: design.root,
        name: design.name,
        ips: ips,
        type: design.type,
        children: answer
        }
      $window.jsonData = json;
      $scope.acejson = angular.toJson(json, 2);
    } //try
    catch (error) {
      alert(error);
    } //catch
  } //do
};

</script>
</html>
